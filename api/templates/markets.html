{% extends 'base.html' %}
{% block title %}Markets{% endblock %}
{% block content %}
<div class="nes-container with-title is-centered is-rounded" style="margin-top:2em; background: var(--clr-surface); border-color: var(--clr-primary);">
  <p class="title nes-text is-primary">Prediction Markets</p>
  <div class="markets-table" style="width:100%;">
    <div class="table-header" style="display:flex; background: #181818; color: var(--clr-primary); font-weight:bold;">
      <div class="nes-text is-primary" style="flex:2.5; text-align:center;">Market</div>
      <div class="nes-text is-primary" style="flex:1; text-align:center;">Activity</div>
      <div class="nes-text is-primary" style="flex:1; text-align:center;">Best Bid</div>
      <div class="nes-text is-primary" style="flex:1; text-align:center;">Best Ask</div>
      <div class="nes-text is-primary" style="flex:1; text-align:center;">Action</div>
    </div>
    {% for market in markets %}
    <div class="market-row nes-container is-dark is-rounded" data-market-id="{{ market.id }}" style="display:flex; align-items:center; margin-bottom:1em; background:#23272e; border: 1.5px solid var(--clr-primary);">
      <div class="market-info" style="flex:2.5;">
        <h3 class="nes-text is-primary" style="margin-bottom:0.3em;">{{ market.title }}</h3>
        <p class="nes-text" style="color:#bdbdbd;">{{ market.description }}</p>
      </div>
      <div class="market-activity" style="flex:1; justify-content:center; text-align:center;">
        <span class="order-count nes-badge is-icon">-</span> <span class="nes-text">orders</span>
      </div>
      <div class="best-bid nes-badge is-success" style="flex:1; justify-content:center; text-align:center;">-</div>
      <div class="best-ask nes-badge is-error" style="flex:1; justify-content:center; text-align:center;">-</div>
      <div class="market-action" style="flex:1; justify-content:center; text-align:center;">
        <a href="/markets/{{ market.id }}" class="nes-btn is-primary">View Market</a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMarketOrderbooks();
});
async function loadMarketOrderbooks() {
    const marketRows = document.querySelectorAll('[data-market-id]');
    for (const row of marketRows) {
        const marketId = row.getAttribute('data-market-id');
        await loadOrderbookForMarket(marketId, row);
    }
}
async function loadOrderbookForMarket(marketId, row) {
    try {
        const response = await fetch(`/api/markets/${marketId}/orderbook`);
        const data = await response.json();
        if (data.success) {
            const orderbook = data.orderbook;
            const totalOrders = 
                orderbook.yes_token.bids.length + 
                orderbook.yes_token.asks.length + 
                orderbook.no_token.bids.length + 
                orderbook.no_token.asks.length;
            let bestBid = null;
            const allBids = [...orderbook.yes_token.bids, ...orderbook.no_token.bids];
            if (allBids.length > 0) {
                bestBid = Math.max(...allBids.map(bid => bid.price));
            }
            let bestAsk = null;
            const allAsks = [...orderbook.yes_token.asks, ...orderbook.no_token.asks];
            if (allAsks.length > 0) {
                bestAsk = Math.min(...allAsks.map(ask => ask.price));
            }
            updateMarketRow(row, totalOrders, bestBid, bestAsk);
        }
    } catch (error) {
        console.error(`Error loading orderbook for market ${marketId}:`, error);
        updateMarketRow(row, 0, null, null);
    }
}
function updateMarketRow(row, totalOrders, bestBid, bestAsk) {
    const orderCountElement = row.querySelector('.order-count');
    if (orderCountElement) {
        orderCountElement.textContent = totalOrders;
    }
    const bestBidElement = row.querySelector('.best-bid');
    if (bestBidElement) {
        bestBidElement.textContent = bestBid ? `$${bestBid.toFixed(2)}` : 'no bids';
    }
    const bestAskElement = row.querySelector('.best-ask');
    if (bestAskElement) {
        bestAskElement.textContent = bestAsk ? `$${bestAsk.toFixed(2)}` : 'no asks';
    }
}
</script>
{% endblock %}